graph TB
    %% Entry Point
    Start["ğŸ” Start Granularity Analysis"]
    
    %% Input Assessment
    InputAnalysis["ğŸ“Š Analyze Input<br/>â€¢ Extract table name patterns<br/>â€¢ Count total rows<br/>â€¢ Gather column metadata<br/>â€¢ Collect business context"]
    
    %% Performance Gate
    SizeGate{"ğŸ“ Performance Check<br/>Table has >10B rows?"}
    
    %% Fast Path for Large Tables
    FastPath["âš¡ Lightweight Analysis<br/>â€¢ Skip deep queries<br/>â€¢ Use AI predictions only<br/>â€¢ Optimize for speed"]
    FastResult["ğŸ“‹ Quick Result<br/>AI-predicted entity level<br/>with performance notes"]
    
    %% AI-Powered Column Prediction
    AIAnalysis["ğŸ§  AI Column Analysis<br/>Send table structure to LLM:<br/>â€¢ Table name hints<br/>â€¢ Column names & types<br/>â€¢ Business context<br/>â€¢ Usage patterns"]
    
    %% Smart Time Window Logic
    TimeLogic["â±ï¸ Adaptive Time Windows<br/>Based on table size:<br/>â€¢ Massive tables: 1 day<br/>â€¢ Large tables: 3 days<br/>â€¢ Medium tables: 7 days<br/>â€¢ Small tables: 30 days"]
    
    %% Prediction Results
    Predictions["ğŸ¯ AI Predictions<br/>â€¢ Most likely entity column<br/>â€¢ Time column for filtering<br/>â€¢ Calculated lookback period"]
    
    %% Technical Uniqueness Check
    TechCheck["ğŸ”§ Technical Uniqueness Scan<br/>Test each column for uniqueness<br/>to find actual granularity"]
    
    %% Entity Validation Gate
    EntityGate{"â“ Found Entity Column?"}
    NoEntityPath["âŒ No Entity Found<br/>Cannot determine<br/>business granularity"]
    
    %% Duplicate Testing
    DuplicateCheck["ğŸ” Duplicate Analysis<br/>Count duplicates in predicted<br/>entity column with time filter"]
    
    %% Granularity Decision
    GranularityDecision{"ğŸ“Š Duplicate Count > 0?"}
    
    %% Simple Case: Unique Entity
    UniqueCase["âœ… Simple Granularity<br/>â€¢ Each row = unique entity<br/>â€¢ 1:1 mapping confirmed<br/>â€¢ Granularity identified"]
    
    %% Complex Case: Multiple Rows per Entity
    ComplexCase["ğŸ” Complex Investigation<br/>Entity has multiple rows<br/>Need to understand why"]
    
    %% Sample Investigation
    SampleStrategy["ğŸ“ Sample Investigation<br/>â€¢ Find entity with duplicates<br/>â€¢ Extract sample rows<br/>â€¢ Apply time filtering<br/>â€¢ Limit sample size"]
    
    %% Change Pattern Analysis
    ChangeAnalysis["ğŸ”„ Change Pattern Detection<br/>â€¢ Compare rows for same entity<br/>â€¢ Identify changing columns<br/>â€¢ Extract timeline information<br/>â€¢ Detect variation patterns"]
    
    %% AI Pattern Recognition
    PatternAI["ğŸ§  AI Pattern Analysis<br/>Send sample data to LLM:<br/>â€¢ Sample rows for entity<br/>â€¢ Changing columns<br/>â€¢ Timeline data<br/>â€¢ Ask for pattern explanation"]
    
    %% Heuristic Pattern Detection
    HeuristicPatterns["ğŸ” Pattern Recognition Logic<br/>Analyze changing columns for:<br/>â€¢ Date/time patterns<br/>â€¢ Status/flag patterns<br/>â€¢ Version/sequence patterns<br/>â€¢ ID relationship patterns"]
    
    %% Pattern Classification
    subgraph "Pattern Types Detected"
        SCDType["ğŸ“Š Slowly Changing Dimension<br/>Tracks attribute changes<br/>over time with dates"]
        EventType["ğŸ“… Event/Transaction Log<br/>Multiple events per entity<br/>with timestamps"]
        StatusType["ğŸ”„ Status Tracking<br/>State changes with<br/>status/flag columns"]
        VersionType["ğŸ”¢ Version Control<br/>Multiple versions per<br/>entity with sequences"]
        RelationType["ğŸ”— Relationship Mapping<br/>Entity linked to multiple<br/>other entities"]
        PartitionType["ğŸ“‚ Data Partitioning<br/>Same entity across<br/>different segments"]
        MetricType["ğŸ“ˆ Metric Aggregation<br/>Different measurements<br/>for same entity"]
        UnknownType["â“ Complex Business Logic<br/>Pattern unclear,<br/>needs investigation"]
    end
    
    %% Business Explanation Generation
    BusinessExplanation["ğŸ’¼ Business Context Generation<br/>AI generates user-friendly<br/>explanation of why entity<br/>has multiple rows"]
    
    %% Final Results Assembly
    ComplexResult["ğŸ“‹ Complex Granularity Result<br/>â€¢ Entity level identified<br/>â€¢ Pattern explanation<br/>â€¢ Business reasoning<br/>â€¢ Sample evidence<br/>â€¢ Timeline analysis"]
    
    %% Data Interaction Points
    subgraph "Data Sources"
        Database[("â„ï¸ Live Database<br/>Sample queries<br/>Duplicate counts<br/>Uniqueness tests")]
        AI[("ğŸ¤– AI Service<br/>Pattern recognition<br/>Business explanations<br/>Column predictions")]
    end
    
    %% Error Handling
    ErrorFallback["ğŸ› ï¸ Graceful Fallback<br/>â€¢ Use heuristic patterns<br/>â€¢ Provide partial results<br/>â€¢ Log analysis attempts"]
    
    %% Main Flow
    Start --> InputAnalysis
    InputAnalysis --> SizeGate
    
    %% Size-based routing
    SizeGate -->|Yes| FastPath
    FastPath --> FastResult
    SizeGate -->|No| AIAnalysis
    
    %% Normal analysis flow
    AIAnalysis --> TimeLogic
    TimeLogic --> Predictions
    Predictions --> TechCheck
    TechCheck --> EntityGate
    
    %% Entity validation routing
    EntityGate -->|No| NoEntityPath
    EntityGate -->|Yes| DuplicateCheck
    
    %% Granularity analysis routing
    DuplicateCheck --> GranularityDecision
    GranularityDecision -->|No| UniqueCase
    GranularityDecision -->|Yes| ComplexCase
    
    %% Complex case investigation
    ComplexCase --> SampleStrategy
    SampleStrategy --> ChangeAnalysis
    ChangeAnalysis --> PatternAI
    PatternAI --> HeuristicPatterns
    
    %% Pattern routing
    HeuristicPatterns --> SCDType
    HeuristicPatterns --> EventType
    HeuristicPatterns --> StatusType
    HeuristicPatterns --> VersionType
    HeuristicPatterns --> RelationType
    HeuristicPatterns --> PartitionType
    HeuristicPatterns --> MetricType
    HeuristicPatterns --> UnknownType
    
    %% Business explanation
    PatternAI --> BusinessExplanation
    BusinessExplanation --> ComplexResult
    
    %% External connections
    AIAnalysis -.-> AI
    PatternAI -.-> AI
    BusinessExplanation -.-> AI
    DuplicateCheck -.-> Database
    SampleStrategy -.-> Database
    TechCheck -.-> Database
    
    %% Error handling
    AIAnalysis -.->|Error| ErrorFallback
    SampleStrategy -.->|Error| ErrorFallback
    PatternAI -.->|Error| ErrorFallback
    
    %% Styling
    classDef startClass fill:#e8f5e8,stroke:#2e7d32,stroke-width:3px
    classDef decisionClass fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef processClass fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef aiClass fill:#fff8e1,stroke:#f9a825,stroke-width:2px
    classDef resultClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef patternClass fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef dataClass fill:#f1f8e9,stroke:#388e3c,stroke-width:2px
    classDef errorClass fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    
    class Start startClass
    class SizeGate,EntityGate,GranularityDecision decisionClass
    class InputAnalysis,TimeLogic,TechCheck,DuplicateCheck,SampleStrategy,ChangeAnalysis,HeuristicPatterns processClass
    class AIAnalysis,PatternAI,BusinessExplanation aiClass
    class FastResult,UniqueCase,ComplexResult,NoEntityPath,Predictions resultClass
    class SCDType,EventType,StatusType,VersionType,RelationType,PartitionType,MetricType,UnknownType patternClass
    class Database,AI dataClass
    class ErrorFallback errorClass
